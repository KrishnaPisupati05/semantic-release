name: Deploy on Release

on:
  release:
    types: [published]
  
    inputs:
      tag:
        description: "Tag to deploy (defaults to latest release)"
        required: false

permissions:
  contents: read
  id-token: write
  actions: read
    
jobs:
  deploy:
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/deploy-funcapp-reusable.yml
    with:
      function_app_name: functionapp-0194
      resource_group: test-rg
      working_directory: AzureFunctions
      app_version: ${{ github.event_name == 'release' && github.event.release.tag_name
        || github.event_name == 'push' && github.ref_name
        || github.event_name == 'workflow_dispatch' && inputs.tag
        || '' }}
      set_app_setting: true
      use_publish_profile: true
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      AZURE_FUNCTIONAPP_PUBLISH_PROFILE: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}